# LeRobot 数据集质量检测配置文件

# A1: 数据结构规定
expected_features:
  # 相机图像 - 所有相机键统一放置在 observation.images.* 命名空间
  observation.images.camera_top:
    dtype: "video"
    description: "顶部相机"
  observation.images.camera_wrist_left:
    dtype: "video"
    description: "左腕部相机"
  observation.images.camera_wrist_right:
    dtype: "video"
    description: "右腕部相机"
  observation.images.camera_front:
    dtype: "video"
    description: "前部相机"
  observation.images.camera_left:
    dtype: "video"
    description: "左部相机"
  observation.images.camera_right:
    dtype: "video"
    description: "右部相机"

  # 状态观测 - observation.state.*
  observation.state.arm.position:
    dtype: "float32"
    dim: 14
    description: "机器人臂部关节位置，双臂(7+7)，单臂仅使用前7维"
  observation.state.arm.velocity:
    dtype: "float32"
    dim: 14
    description: "机器人臂部关节速度"
  observation.state.arm.effort:
    dtype: "float32"
    dim: 14
    description: "机器人臂部关节力矩"

  observation.state.effector.position:
    dtype: "float32"
    dim: 2
    description: "简易夹爪(1+1)"
  observation.state.effector.velocity:
    dtype: "float32"
    dim: 2
  observation.state.effector.effort:
    dtype: "float32"
    dim: 2

  observation.state.end.position:
    dtype: "float32"
    dim: 14
    description: "两末端6D位姿(2×7)四元数"
  observation.state.end.velocity:
    dtype: "float32"
    dim: 14
  observation.state.end.effort:
    dtype: "float32"
    dim: 14
    description: "如果有六维力传感器放到effort中"

  observation.state.base.position:
    dtype: "float32"
    dim: 7
    description: "移动底盘6D位姿，差速底盘按照线速度和yaw角速度"
  observation.state.base.velocity:
    dtype: "float32"
    dim: 7
  observation.state.base.effort:
    dtype: "float32"
    dim: 7

  observation.state.waist.position:
    dtype: "float32"
    dim: 7
    description: "腰部关节（预留），躯干4DOF，实现上下/俯仰/旋转"
  observation.state.waist.velocity:
    dtype: "float32"
    dim: 7
  observation.state.waist.effort:
    dtype: "float32"
    dim: 7

  observation.state.head.position:
    dtype: "float32"
    dim: 7
    description: "头部关节（预留）"
  observation.state.head.velocity:
    dtype: "float32"
    dim: 7
  observation.state.head.effort:
    dtype: "float32"
    dim: 7

  observation.state.hand.position:
    dtype: "float32"
    description: "灵巧手（占位）"
  observation.state.hand.velocity:
    dtype: "float32"
  observation.state.hand.effort:
    dtype: "float32"

  observation.state.leg.position:
    dtype: "float32"
    description: "足式机器人（占位）"
  observation.state.leg.velocity:
    dtype: "float32"
  observation.state.leg.effort:
    dtype: "float32"

  # 动作 - action.* (命名同 state 一致，只需要将state换为action)
  action.arm.position:
    dtype: "float32"
    dim: 14
  action.arm.velocity:
    dtype: "float32"
    dim: 14
  action.arm.effort:
    dtype: "float32"
    dim: 14

  action.effector.position:
    dtype: "float32"
    dim: 2
  action.effector.velocity:
    dtype: "float32"
    dim: 2
  action.effector.effort:
    dtype: "float32"
    dim: 2

  action.end.position:
    dtype: "float32"
    dim: 14
  action.end.velocity:
    dtype: "float32"
    dim: 14
  action.end.effort:
    dtype: "float32"
    dim: 14

  action.base.position:
    dtype: "float32"
    dim: 7
  action.base.velocity:
    dtype: "float32"
    dim: 7
  action.base.effort:
    dtype: "float32"
    dim: 7

  action.waist.position:
    dtype: "float32"
    dim: 7
  action.waist.velocity:
    dtype: "float32"
    dim: 7
  action.waist.effort:
    dtype: "float32"
    dim: 7

  action.head.position:
    dtype: "float32"
    dim: 7
  action.head.velocity:
    dtype: "float32"
    dim: 7
  action.head.effort:
    dtype: "float32"
    dim: 7

  action.hand.position:
    dtype: "float32"
  action.hand.velocity:
    dtype: "float32"
  action.hand.effort:
    dtype: "float32"

  action.leg.position:
    dtype: "float32"
  action.leg.velocity:
    dtype: "float32"
  action.leg.effort:
    dtype: "float32"

# A2: 统计信息检查 - 允许为0的字段白名单（可选）
# 如果某些字段预期就是全0，可以添加到这里避免误报
allow_zero_fields: []

# B1: 异常静止检测参数（多维度综合检测）
static_detection:
  window_sec: 3.0                    # 窗口长度（秒）
  step_sec: 1.0                      # 滑动步长（秒）
  angle_range_threshold: 0.01        # 角度范围阈值（弧度）
  max_static_ratio: 0.15             # 最大静止帧占比（15%）

  # 多维度运动检测键（只有所有维度都静止才算真正静止）
  # arm 关节列表
  arm_joint_keys:
    - "action.arm.position"
    - "observation.state.arm.position"

  # base 底盘运动（可选，如果有移动底盘）
  base_keys:
    - "action.base.position"
    - "action.base.velocity"
    - "observation.state.base.position"
    - "observation.state.base.velocity"

  # waist 腰部运动（可选）
  waist_keys:
    - "action.waist.position"
    - "observation.state.waist.position"

  # head 头部运动（可选）
  head_keys:
    - "action.head.position"
    - "observation.state.head.position"

  # effector 夹爪运动（可选）
  effector_keys:
    - "action.effector.position"
    - "observation.state.effector.position"

# B2: 角度域与 Gripper 检查
angle_gripper_check:
  # Gripper 提取规则(支持两种模式)
  gripper_extraction:
    # 模式1: 独立字段(优先尝试)
    standalone_keys:
      - "action.effector.position"
      - "observation.state.effector.position"
    
    # 模式2: 从 arm.position 中提取指定维度（可选）
    embedded_rules:
      # 从 action.arm.position 的指定维度索引
      "action.arm.position":
        indices: [7, 14]  # 支持负索引
        description: "左右夹爪嵌入在双臂数据末尾"
      
      # 也可以指定绝对索引
      "observation.state.arm.position":
        indices: [7, 14]  # 或者 [7, 14] 等
        description: "单臂+双夹爪配置"
  # Gripper 物理限制(机型特定)
  gripper_min: 0.0
  gripper_max: 1.0

  # 角度字段列表（需要检测角度域）
  angle_keys:
    - "action.arm.position"
    - "observation.state.arm.position"
    - "action.waist.position"
    - "observation.state.waist.position"
    - "action.head.position"
    - "observation.state.head.position"

# B3: 原始信号异常检测参数
anomaly_detection:
  fps: 30                            # 采样频率

  # 离群值检测 - MAD (Median Absolute Deviation) 倍数
  angle_mad_k: 3.0
  vel_mad_k: 3.0
  acc_mad_k: 3.0

  # 突变/尖峰检测
  dtheta_thr: 3                    # 一阶差分阈值（弧度）
  d2theta_thr: 20                   # 二阶差分阈值（弧度/帧²）
  min_consecutive: 3                 # 最小连续帧数

  # 抖动/不顺滑检测
  tv_per_sec_thr: 10.0               # 单位时间总变差阈值（弧度/秒）

  # 报告参数
  top_k: 10                          # 报告 Top-K 异常片段

  # B3极端情况阈值（仅极端情况才算失败）
  b3_critical_thresholds:
    outlier_ratio_critical: 0.50        # 离群值>50%算极端
    spike_ratio_1st_critical: 0.30      # 一阶导数尖峰>30%算极端
    spike_ratio_2nd_critical: 0.30      # 二阶导数尖峰>30%算极端
    jerk_ratio_critical: 0.20           # jerk异常>20%算极端
    tv_per_sec_critical: 30.0           # 总变差>30 rad/s算极端

  # 物理限制（可选）- 如果不提供则仅报告分位数
  motor_limits:
    # 示例配置，根据实际机器人参数修改
    # "action.arm.position":
    #   angle_min: -3.14159
    #   angle_max: 3.14159
    #   velocity_max: 3.0
    #   acceleration_max: 10.0

# B4: 时间戳一致性检查参数
timestamp_check:
  tolerance_ms: 0.1                   # 时间戳与期望FPS间隔的容差（毫秒）

# 全局设置
global:
  # 是否对角度进行 unwrap 处理
  unwrap_angles: true

  # 报告格式
  output_formats:
    - "json"
    - "markdown"

  # 日志级别
  log_level: "INFO"
